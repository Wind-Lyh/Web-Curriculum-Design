# 简化后的类与系统功能映射关系

## 一、功能规格与类对应关系

### 第一部分：普通注册用户功能

#### A. 账户管理功能
| 功能点        | 对应Servlet                | 对应Service     | 对应DAO                      | 对应JSP页面  |
| ------------- | -------------------------- | --------------- | ---------------------------- | ------------ |
| 注册          | UserServlet                | UserServiceImpl | UserDaoImpl                  | register.jsp |
| 登录/登出     | UserServlet, LogoutServlet | UserServiceImpl | UserDaoImpl, LoginLogDaoImpl | login.jsp    |
| 修改个人资料  | UserServlet                | UserServiceImpl | UserDaoImpl                  | profile.jsp  |
| 上传头像      | FileServlet                | FileServiceImpl | FileDaoImpl                  | profile.jsp  |
| 修改密码      | UserServlet                | UserServiceImpl | UserDaoImpl                  | password.jsp |
| 绑定邮箱/手机 | UserServlet                | UserServiceImpl | UserDaoImpl                  | profile.jsp  |
| 查看个人主页  | UserServlet                | UserServiceImpl | UserDaoImpl                  | profile.jsp  |

#### B. 内容发布功能
| 功能点         | 对应Servlet    | 对应Service        | 对应DAO                     | 对应JSP页面 |
| -------------- | -------------- | ------------------ | --------------------------- | ----------- |
| 发布新帖子     | PostServlet    | PostServiceImpl    | PostDaoImpl, SectionDaoImpl | create.jsp  |
| 编辑自己的帖子 | PostServlet    | PostServiceImpl    | PostDaoImpl                 | edit.jsp    |
| 删除自己的帖子 | PostServlet    | PostServiceImpl    | PostDaoImpl                 | manage.jsp  |
| 发布评论/回复  | CommentServlet | CommentServiceImpl | CommentDaoImpl              | detail.jsp  |
| 编辑自己的评论 | CommentServlet | CommentServiceImpl | CommentDaoImpl              | detail.jsp  |
| 删除自己的评论 | CommentServlet | CommentServiceImpl | CommentDaoImpl              | detail.jsp  |
| 上传图片/附件  | FileServlet    | FileServiceImpl    | FileDaoImpl                 | create.jsp  |

#### C. 内容互动功能
| 功能点           | 对应Servlet         | 对应Service             | 对应DAO             | 对应JSP页面          |
| ---------------- | ------------------- | ----------------------- | ------------------- | -------------------- |
| 点赞/取消点赞    | LikeServlet         | LikeServiceImpl         | LikeDaoImpl         | detail.jsp           |
| 收藏/取消收藏    | FavoriteServlet     | FavoriteServiceImpl     | FavoriteDaoImpl     | detail.jsp           |
| 查看回复我的评论 | NotificationServlet | NotificationServiceImpl | NotificationDaoImpl | my_notifications.jsp |

#### D. 个人中心功能
| 功能点       | 对应Servlet         | 对应Service             | 对应DAO             | 对应JSP页面          |
| ------------ | ------------------- | ----------------------- | ------------------- | -------------------- |
| 查看我的帖子 | PostServlet         | PostServiceImpl         | PostDaoImpl         | my_posts.jsp         |
| 查看我的评论 | CommentServlet      | CommentServiceImpl      | CommentDaoImpl      | my_comments.jsp      |
| 查看我的收藏 | FavoriteServlet     | FavoriteServiceImpl     | FavoriteDaoImpl     | my_favorites.jsp     |
| 查看消息通知 | NotificationServlet | NotificationServiceImpl | NotificationDaoImpl | my_notifications.jsp |
| 查看积分详情 | PointsServlet       | PointsServiceImpl       | PointsDaoImpl       | points.jsp           |
| 查看等级进度 | PointsServlet       | PointsServiceImpl       | PointsDaoImpl       | points.jsp           |

#### E. 积分系统功能
| 功能点             | 对应Servlet                 | 对应Service       | 对应DAO                                            | 对应JSP页面 |
| ------------------ | --------------------------- | ----------------- | -------------------------------------------------- | ----------- |
| 发帖/评论获得积分  | PostServlet, CommentServlet | PointsServiceImpl | PointsDaoImpl                                      | 自动计算    |
| 帖子被点赞获得积分 | LikeServlet                 | PointsServiceImpl | PointsDaoImpl                                      | 自动计算    |
| 积分兑换虚拟道具   | PointsServlet               | PointsServiceImpl | PointsDaoImpl, VirtualGoodDaoImpl, ExchangeDaoImpl | points.jsp  |
| 查看积分排行榜     | PointsServlet               | PointsServiceImpl | PointsDaoImpl                                      | points.jsp  |

#### F. 个性化功能
| 功能点       | 对应Servlet         | 对应Service     | 对应DAO              | 对应JSP页面    |
| ------------ | ------------------- | --------------- | -------------------- | -------------- |
| 设置个人签名 | UserServlet         | UserServiceImpl | UserDaoImpl          | profile.jsp    |
| 查看浏览历史 | 可添加到PostServlet | PostServiceImpl | BrowseHistoryDaoImpl | 集成在个人中心 |

### 第二部分：系统管理员（Admin）功能

#### A. 用户管理功能
| 功能点           | 对应Servlet  | 对应Service      | 对应DAO         | 对应JSP页面     |
| ---------------- | ------------ | ---------------- | --------------- | --------------- |
| 查看所有用户列表 | AdminServlet | AdminServiceImpl | UserDaoImpl     | user_manage.jsp |
| 用户搜索与筛选   | AdminServlet | AdminServiceImpl | UserDaoImpl     | user_manage.jsp |
| 封禁/解封用户    | AdminServlet | AdminServiceImpl | UserDaoImpl     | user_manage.jsp |
| 重置用户密码     | AdminServlet | AdminServiceImpl | UserDaoImpl     | user_manage.jsp |
| 查看用户登录记录 | AdminServlet | AdminServiceImpl | LoginLogDaoImpl | system_log.jsp  |

#### B. 内容管理功能
| 功能点           | 对应Servlet  | 对应Service      | 对应DAO                     | 对应JSP页面        |
| ---------------- | ------------ | ---------------- | --------------------------- | ------------------ |
| 管理全站所有帖子 | AdminServlet | AdminServiceImpl | PostDaoImpl                 | post_manage.jsp    |
| 管理全站所有评论 | AdminServlet | AdminServiceImpl | CommentDaoImpl              | comment_manage.jsp |
| 审核全站内容     | AdminServlet | AdminServiceImpl | PostDaoImpl, CommentDaoImpl | 各管理页面         |
| 批量内容操作     | AdminServlet | AdminServiceImpl | PostDaoImpl, CommentDaoImpl | 各管理页面         |

## 二、各类详细功能说明

### 1. **Servlet控制器层功能**

#### UserServlet.java
- **注册功能**：接收注册表单，验证数据，创建新用户
- **登录功能**：验证用户名密码，创建Session，记录登录日志
- **退出登录**：销毁Session，清除用户登录状态
- **个人资料**：显示和更新用户基本信息
- **密码管理**：修改用户密码
- **头像管理**：处理头像上传请求（可委托给FileServlet）
- **我的帖子/评论**：显示用户发布的帖子和评论

#### PostServlet.java
- **帖子列表**：显示所有帖子，支持分页和搜索
- **帖子详情**：显示单个帖子内容和评论
- **发布帖子**：接收表单，创建新帖子
- **编辑帖子**：验证权限，更新帖子内容
- **删除帖子**：逻辑删除或物理删除帖子
- **版块帖子**：显示特定版块的帖子列表

#### CommentServlet.java
- **评论列表**：显示帖子的所有评论
- **发布评论**：接收评论表单，创建新评论
- **回复评论**：处理对评论的回复
- **编辑评论**：验证权限，更新评论内容
- **删除评论**：删除用户自己的评论

#### LikeServlet.java
- **点赞帖子**：添加帖子点赞记录
- **取消点赞**：删除帖子点赞记录
- **点赞评论**：添加评论点赞记录
- **取消点赞评论**：删除评论点赞记录
- **点赞状态**：查询用户是否点赞了某内容

#### FavoriteServlet.java
- **收藏帖子**：添加帖子收藏记录
- **取消收藏**：删除帖子收藏记录
- **收藏列表**：显示用户收藏的帖子

#### PointsServlet.java
- **积分查询**：显示用户当前积分和等级
- **积分记录**：显示用户积分变动历史
- **积分排行**：显示全站积分排行榜
- **兑换道具**：处理虚拟道具兑换请求

#### FileServlet.java
- **文件上传**：处理文件上传请求
- **文件下载**：提供文件下载功能
- **图片显示**：显示上传的图片
- **头像上传**：专门处理头像上传和裁剪

#### AdminServlet.java
- **用户管理**：用户列表、封禁解封、密码重置
- **帖子管理**：全站帖子管理、审核、删除
- **评论管理**：全站评论管理、审核、删除
- **版块管理**：版块增删改查
- **系统日志**：查看用户登录记录和操作日志
- **虚拟道具管理**：管理可兑换的虚拟道具

#### HomeServlet.java
- **首页显示**：显示最新帖子、热门帖子
- **搜索功能**：全站内容搜索
- **版块导航**：显示所有版块列表

#### SectionServlet.java
- **版块列表**：显示所有版块
- **版块详情**：显示版块信息和相关帖子

#### NotificationServlet.java
- **通知列表**：显示用户的所有通知
- **未读通知**：显示未读通知
- **标记已读**：将通知标记为已读

#### CaptchaServlet.java
- **生成验证码**：生成图片验证码
- **验证码校验**：验证用户输入的验证码（通常由其他Servlet调用）

#### LogoutServlet.java
- **退出登录**：销毁Session，清除登录状态

### 2. **Service业务层功能**

#### UserServiceImpl.java
```java
public class UserServiceImpl implements UserService {
    // 注册：检查用户名唯一性，密码加密，初始化用户数据
    public boolean register(String username, String password, String email) {
        // 1. 检查用户名是否已存在
        // 2. 密码加密（使用BCrypt）
        // 3. 设置默认值（积分100，等级1，默认头像）
        // 4. 插入数据库
        // 5. 记录注册日志
    }
    
    // 登录：验证密码，更新登录状态，记录日志
    public User login(String username, String password) {
        // 1. 根据用户名查询用户
        // 2. 验证密码
        // 3. 检查是否被封禁
        // 4. 更新最后登录时间
        // 5. 记录登录日志
    }
    
    // 更新个人资料
    public boolean updateProfile(int userId, String nickname, String signature) {
        // 1. 验证用户存在
        // 2. 更新资料
        // 3. 返回结果
    }
    
    // 修改密码
    public boolean changePassword(int userId, String oldPassword, String newPassword) {
        // 1. 验证原密码
        // 2. 加密新密码
        // 3. 更新密码
    }
}
```

#### PostServiceImpl.java
```java
public class PostServiceImpl implements PostService {
    // 发布帖子
    public boolean createPost(Post post) {
        // 1. 验证版块存在
        // 2. 设置初始值（浏览0，点赞0，评论0）
        // 3. 插入数据库
        // 4. 调用积分服务增加积分
    }
    
    // 编辑帖子
    public boolean updatePost(int postId, int userId, String title, String content) {
        // 1. 验证帖子存在
        // 2. 验证用户是作者
        // 3. 更新内容
    }
    
    // 删除帖子（逻辑删除）
    public boolean deletePost(int postId, int userId, boolean isAdmin) {
        // 1. 验证权限（作者或管理员）
        // 2. 标记为删除状态
    }
    
    // 查询帖子
    public Post getPostById(int postId) {
        // 1. 查询帖子
        // 2. 增加浏览计数
        // 3. 记录浏览历史
    }
}
```

#### CommentServiceImpl.java
```java
public class CommentServiceImpl implements CommentService {
    // 发布评论
    public boolean addComment(Comment comment) {
        // 1. 验证帖子存在
        // 2. 设置默认值
        // 3. 插入数据库
        // 4. 更新帖子评论数
        // 5. 调用积分服务增加积分
        // 6. 如果回复他人，生成通知
    }
    
    // 删除评论
    public boolean deleteComment(int commentId, int userId, boolean isAdmin) {
        // 1. 验证权限
        // 2. 逻辑删除
        // 3. 更新帖子评论数
    }
}
```

#### LikeServiceImpl.java
```java
public class LikeServiceImpl implements LikeService {
    // 点赞帖子
    public boolean likePost(int postId, int userId) {
        // 1. 检查是否已点赞
        // 2. 添加点赞记录
        // 3. 更新帖子点赞数
        // 4. 给帖子作者增加积分
        // 5. 生成通知
    }
    
    // 取消点赞
    public boolean unlikePost(int postId, int userId) {
        // 1. 删除点赞记录
        // 2. 更新帖子点赞数
    }
}
```

#### PointsServiceImpl.java
```java
public class PointsServiceImpl implements PointsService {
    // 计算用户等级
    public int calculateLevel(int points) {
        // 根据积分计算等级
        if (points < 100) return 1;
        else if (points < 500) return 2;
        else if (points < 2000) return 3;
        else if (points < 5000) return 4;
        else if (points < 15000) return 5;
        else return 6;
    }
    
    // 增加积分
    public boolean addPoints(int userId, int points, String reason) {
        // 1. 检查每日上限
        // 2. 增加积分
        // 3. 记录积分变动
        // 4. 更新用户等级
    }
    
    // 兑换虚拟道具
    public boolean exchangeGoods(int userId, int goodsId, int quantity) {
        // 1. 验证道具存在且有库存
        // 2. 计算总积分
        // 3. 验证用户积分足够
        // 4. 扣除积分
        // 5. 减少库存
        // 6. 记录兑换
    }
}
```

### 3. **DAO数据访问层功能**

#### UserDaoImpl.java
```java
public class UserDaoImpl implements UserDao {
    // 基础CRUD操作
    public User findById(int id) {
        // 根据ID查询用户
        String sql = "SELECT * FROM users WHERE id = ?";
        // 执行查询，返回User对象
    }
    
    public User findByUsername(String username) {
        // 根据用户名查询用户
    }
    
    public boolean insert(User user) {
        // 插入新用户
    }
    
    public boolean update(User user) {
        // 更新用户信息
    }
    
    public boolean delete(int id) {
        // 删除用户（逻辑删除）
    }
    
    // 复杂查询
    public List<User> findAll(int page, int size) {
        // 分页查询所有用户
    }
    
    public List<User> search(String keyword, int status) {
        // 搜索用户
    }
}
```

#### PostDaoImpl.java
```java
public class PostDaoImpl implements PostDao {
    // 帖子相关操作
    public Post findById(int id) {
        // 查询单个帖子
    }
    
    public List<Post> findBySectionId(int sectionId, int page, int size) {
        // 查询版块下的帖子
    }
    
    public List<Post> findByUserId(int userId, int page, int size) {
        // 查询用户发布的帖子
    }
    
    public List<Post> findHotPosts(int limit) {
        // 查询热门帖子
    }
    
    public List<Post> findLatestPosts(int limit) {
        // 查询最新帖子
    }
    
    public boolean insert(Post post) {
        // 插入新帖子
    }
    
    public boolean update(Post post) {
        // 更新帖子
    }
    
    public boolean increaseViewCount(int postId) {
        // 增加浏览数
    }
    
    public boolean increaseLikeCount(int postId) {
        // 增加点赞数
    }
    
    public boolean decreaseLikeCount(int postId) {
        // 减少点赞数
    }
}
```

#### CommentDaoImpl.java
```java
public class CommentDaoImpl implements CommentDao {
    // 评论相关操作
    public List<Comment> findByPostId(int postId) {
        // 查询帖子的所有评论
    }
    
    public List<Comment> findByUserId(int userId, int page, int size) {
        // 查询用户的所有评论
    }
    
    public Comment findById(int id) {
        // 根据ID查询评论
    }
    
    public boolean insert(Comment comment) {
        // 插入评论
    }
    
    public boolean update(Comment comment) {
        // 更新评论
    }
    
    public boolean delete(int id) {
        // 删除评论
    }
    
    public int countByPostId(int postId) {
        // 统计帖子评论数
    }
}
```

### 4. **Util工具类功能**

#### DBUtil.java
- **获取连接**：提供数据库连接
- **关闭资源**：自动关闭Connection、Statement、ResultSet
- **事务管理**：支持事务操作

#### SecurityUtil.java
- **密码加密**：使用BCrypt加密密码
- **密码验证**：验证密码是否正确
- **生成Token**：生成验证token

#### StringUtil.java
- **判空**：检查字符串是否为空
- **格式化**：格式化字符串
- **转义**：转义HTML特殊字符，防止XSS

#### DateUtil.java
- **格式化日期**：将日期格式化为字符串
- **解析日期**：将字符串解析为日期
- **日期计算**：计算日期差、加减日期

#### FileUtil.java
- **文件验证**：验证文件类型和大小
- **文件保存**：保存上传的文件
- **路径处理**：处理文件路径

#### JsonUtil.java
- **序列化**：将Java对象转为JSON字符串
- **反序列化**：将JSON字符串转为Java对象

#### PageUtil.java
- **分页计算**：计算总页数、起始位置
- **分页封装**：封装分页数据

#### ImageUtil.java
- **图片压缩**：压缩图片大小
- **生成缩略图**：生成图片缩略图
- **图片裁剪**：裁剪图片

#### CaptchaUtil.java
- **生成验证码**：生成图片验证码
- **验证验证码**：验证用户输入的验证码

### 5. **Filter过滤器功能**

#### CharacterEncodingFilter.java
- **设置编码**：统一设置为UTF-8编码

#### LoginFilter.java
- **登录验证**：检查用户是否登录
- **权限控制**：未登录用户不能访问特定页面

#### AdminFilter.java
- **管理员验证**：检查用户是否管理员
- **权限控制**：非管理员不能访问后台

#### LogFilter.java
- **请求日志**：记录所有请求的URL、参数
- **执行时间**：记录请求执行时间

### 6. **Listener监听器功能**

#### ContextListener.java
- **应用初始化**：应用启动时初始化资源
- **应用销毁**：应用关闭时释放资源

#### SessionListener.java
- **会话创建**：用户登录时记录
- **会话销毁**：用户退出或超时时清理

#### RequestListener.java
- **请求统计**：统计请求次数
- **性能监控**：监控请求性能

### 7. **Exception异常类功能**

#### BusinessException.java
- **业务异常**：处理业务逻辑错误

#### AuthenticationException.java
- **认证异常**：处理登录认证失败

#### AuthorizationException.java
- **授权异常**：处理权限不足错误

## 三、核心业务流程

### 用户注册流程
```
1. 用户访问 register.jsp
2. 填写表单提交到 UserServlet (action=register)
3. UserServlet 调用 UserService.register()
4. UserService 调用 UserDao.insert()
5. 同时初始化用户积分、等级
6. 返回注册结果，跳转到登录页面
```

### 用户发帖流程
```
1. 用户登录后访问 create.jsp
2. 填写帖子内容，提交到 PostServlet (action=create)
3. PostServlet 调用 PostService.createPost()
4. PostService 验证数据，调用 PostDao.insert()
5. 同时调用 PointsService 增加发帖积分
6. 返回结果，跳转到帖子详情页
```

### 帖子点赞流程
```
1. 用户在帖子详情页点击点赞按钮
2. 发送AJAX请求到 LikeServlet (action=likePost)
3. LikeServlet 调用 LikeService.likePost()
4. LikeService 检查是否已点赞，然后调用 LikeDao.insert()
5. 同时更新帖子点赞数，给作者增加积分
6. 返回点赞结果给前端
```

### 管理员封禁用户流程
```
1. 管理员登录后台，访问 user_manage.jsp
2. 点击封禁按钮，提交到 AdminServlet (action=banUser)
3. AdminServlet 调用 AdminService.banUser()
4. AdminService 调用 UserDao.updateStatus()
5. 记录管理员操作日志
6. 返回操作结果
```

## 四、技术实现要点

### 1. 数据库连接
```java
// 所有DAO都通过DBUtil获取连接
public class UserDaoImpl implements UserDao {
    public User findById(int id) {
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        User user = null;
        
        try {
            conn = DBUtil.getConnection();
            String sql = "SELECT * FROM users WHERE id = ?";
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, id);
            rs = pstmt.executeQuery();
            
            if (rs.next()) {
                user = new User();
                user.setId(rs.getInt("id"));
                user.setUsername(rs.getString("username"));
                // 设置其他属性...
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            DBUtil.close(conn, pstmt, rs);
        }
        
        return user;
    }
}
```

### 2. 密码加密
```java
// 在SecurityUtil中实现密码加密
public class SecurityUtil {
    // 简单实现，实际项目应使用BCrypt
    public static String encryptPassword(String password) {
        // MD5加盐加密
        String salt = "community_salt";
        return md5(password + salt);
    }
    
    public static boolean verifyPassword(String inputPassword, String storedPassword) {
        String encrypted = encryptPassword(inputPassword);
        return encrypted.equals(storedPassword);
    }
}
```

### 3. 文件上传
```java
// 使用commons-fileupload处理文件上传
public class FileServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) {
        // 检查是否是multipart请求
        if (!ServletFileUpload.isMultipartContent(request)) {
            return;
        }
        
        DiskFileItemFactory factory = new DiskFileItemFactory();
        ServletFileUpload upload = new ServletFileUpload(factory);
        
        try {
            List<FileItem> items = upload.parseRequest(request);
            for (FileItem item : items) {
                if (!item.isFormField()) {
                    // 处理文件上传
                    String fileName = item.getName();
                    String filePath = "/uploads/" + fileName;
                    File uploadedFile = new File(filePath);
                    item.write(uploadedFile);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 4. 分页查询
```java
// 在DAO中实现分页
public class PostDaoImpl implements PostDao {
    public List<Post> findAll(int page, int size) {
        List<Post> posts = new ArrayList<>();
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        
        try {
            conn = DBUtil.getConnection();
            String sql = "SELECT * FROM posts ORDER BY create_time DESC LIMIT ?, ?";
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, (page - 1) * size);  // 起始位置
            pstmt.setInt(2, size);               // 每页大小
            rs = pstmt.executeQuery();
            
            while (rs.next()) {
                Post post = new Post();
                // 设置属性...
                posts.add(post);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            DBUtil.close(conn, pstmt, rs);
        }
        
        return posts;
    }
}
```

这个简化后的映射关系表清晰地展示了每个功能点对应的具体实现类，帮助你理解整个系统的架构和代码组织。